#!/bin/bash
# ===================== SLURM SETTINGS ========================= #
#SBATCH --nodes=1
#SBATCH --time=XXX:XXX:XXX
#SBATCH --job-name=testScript
#SBATCH --mail-user=dylan.green@eng.ox.ac.uk
#SBATCH --mail-type=ALL
#SBATCH --partition=XXX


solve_single() {
    echo "Running in single core mode..."
    echo "Executing task..."
    
    # make dir for logs file       
    mkdir logs -p
    dir="logs"
    
    echo "running pimpleFoam"
    pimpleFoam > $logs/log.pimpleFoam
}

solve_local() {
    echo "Running in local mode..."
    echo "Executing task..."
    
    # make dir for logs file       
    mkdir logs -p
    dir="logs"    

    echo "decompose the mesh"
    decomposePar -force > $dir/log.decomposePar 
    
    nbSubdomains=$(grep -oP 'nbSubdomains\s+\K\d+' setUp)
    echo "running pimpleFoam on $nbSubdomains"
    mpirun -np $nbSubdomains pimpleFoam -parallel > $dir/log.pimpleFoam
}


solve_cluster() {
    dir="logs/$SlURM_JOB_ID"
    mkdir $dir -p

    echo "Running in cluster mode..." >  $dir/log.solve
    echo "Executing tasks..." >> $dir/log.solve
   
    echo "load modules" >> $dir/log.solve
    module load OpenFOAM/v2006-foss-2020a
    source $FOAM_BASH
    . $WM_PROJECT_DIR/bin/tools/RunFunctions

    # change the number of subdomains used by OpenFOAM
    foamDictionary -entry "nbSubdomains" -set $SLURM_NTASKS setUp

    nbSubdomains=$(grep -oP 'nbSubdomains\s+\K\d+' setUp)
    echo "running pimpleFoam on $nbSubdomains" >> $dir/log.solve
    mpirun -np $nbSubdomains pimpleFoam -parallel > $dir/log.pimpleFoam
}

# Check if at least one argument is provided
if [ $# -eq 0 ]; then
    echo "No mode specified. Please use -single, -local or -cluster."
    exit 1
fi

# Parse command-line arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
    	-single) solve_single; shift ;;
        -local) solve_local; shift ;;
        -cluster) solve_cluster; shift ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 -single | -local | -cluster"
            exit 1
            ;;
    esac
done
